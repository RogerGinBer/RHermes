---
title: "DDA vs Hermes: A thorough comparison in 3 different matrices"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Library calls
```{r message=FALSE, warning=FALSE}
library(RHermes)
library(ggplot2)
library(plotly)
library(dplyr)
```

# Positive analysis - E. coli 
## Importing DDA and Hermes Raw MS2 data
```{r}

DDAfiles <- list.files("D:/Ecoli_GaryMichi/DDA/", pattern = "pos.*mzML", full.names = TRUE)

importMS2 <- function (filelist) {
    filesdata <- mapply(function(f, n) {
        hand <- mzR::openMSfile(f)
        pks <- mzR::peaks(hand)
        h <- mzR::header(hand)
        pks <- pks[which(h$msLevel == 2)]
        h <- h[which(h$msLevel == 2), ]
        h <- cbind(h, runnum = rep(n, times = nrow(h)))
        return(list(h, pks))
    }, filelist, seq_along(filelist))
    heads <- do.call(rbind, filesdata[seq(1, length(filesdata), 
        2)])
    peaks <- unlist(filesdata[seq(2, length(filesdata), 2)], 
        recursive = FALSE)
    return(list(heads, peaks))
}
DDA <- importMS2(DDAfiles)
```

```{r}
Herfiles <- list.files("D:/Ecoli_GaryMichi/tMS2_positive/", pattern = "pos.*mzML", full.names = TRUE)
Her <- importMS2(Herfiles)
```

```{r}
Herscans <- Her[[1]][,c("retentionTime", "precursorMZ")]
Herscans$class <- "Hermes"

DDAscans <- DDA[[1]][,c("retentionTime", "precursorMZ")]
DDAscans$class <- "DDA"

Jointscans <- rbind(Herscans, DDAscans)
ggplotly(ggplot(Jointscans) + geom_point(aes(x=retentionTime, y = precursorMZ, color = class), alpha = 0.7, size = 0.2))

```

## Quantifying overlap between the data
```{r message=FALSE, warning=FALSE}
myHermes <- readRDS("D:/Ecoli_GaryMichi/MS1_pos_results.rds")

myHermes@data@MS2Exp[[1]]@IL@ILParam@filtermz <- 0.02

DDAoverlap <- RHermes:::MSMSimporter(myHermes@data@MS2Exp[[1]]@IL, DDAfiles)
DDAoverlap_header <- do.call(rbind, lapply(DDAoverlap, function(x){if(length(x)!= 0){x[[1]]}}))
DDAoverlap_header_nscans <- do.call(rbind, sapply(DDAoverlap, function(x){if(length(x)!= 0){nrow(x[[1]])}})) %>% as.data.frame()
DDAoverlap_header_nscans$class <- "DDA"

Hermesoverlap <-RHermes:::MSMSimporter(myHermes@data@MS2Exp[[1]]@IL, Herfiles)
Hermesoverlap_header <- do.call(rbind, lapply(Hermesoverlap, function(x){if(length(x)!= 0){x[[1]]}}))
Hermesoverlap_header_nscans <- data.frame(V1 = sapply(Hermesoverlap, function(x){if(length(x)!= 0){nrow(x[[1]])}}))
Hermesoverlap_header_nscans$class <- "Hermes"


olap_summary <- data.frame(counts = c(nrow(DDAoverlap_header),nrow(DDAscans) - nrow(DDAoverlap_header)), 
                                       class = c("Within Hermes IL", "Outside Hermes IL"))
fig <- plot_ly(olap_summary, labels = ~class, values = ~counts, type = 'pie')
fig <- fig %>% layout(title = 'DDA scan location respect to Hermes',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig

mergeNscans <- rbind(DDAoverlap_header_nscans, Hermesoverlap_header_nscans)
ggplot(mergeNscans) + geom_density(aes(x=V1, color = class, fill = class), alpha = 0.7) + xlab("Number of scans per IL entry") + scale_x_continuous(breaks=seq(0,75,5), limits = c(0,75))

numOver <- length(which(sapply(DDAoverlap, function(x){length(x)!= 0})))
numTotal <- nrow(myHermes@data@MS2Exp[[1]]@IL@IL)

```


## Comparing maximum scan intensity (using TIC)
```{r}
DDAcurrent <- sapply(DDAoverlap, function(x){
  if(length(x) == 0){return(0)}
  max(x[[1]]$totIonCurrent)
})
Hermescurrent <- sapply(Hermesoverlap, function(x){
  if(length(x) == 0){return(0)}
  max(x[[1]]$totIonCurrent)
})

notZero <- Hermescurrent != 0 & DDAcurrent != 0
table(Hermescurrent[notZero] > DDAcurrent[notZero])

mergedInt <- data.frame(intH = Hermescurrent[notZero], intD = DDAcurrent[notZero])
mergedInt$diff <- mergedInt$intH-mergedInt$intD
mergedInt$FC <- mergedInt$intH/mergedInt$intD

#Hermes TICs vs DDA TICs
ggplot(mergedInt) + geom_point(aes(x=intH, y=intD)) + scale_x_log10() + scale_y_log10() + geom_abline(aes(slope = 1, intercept = 0), color = "red")

#TIC difference distribution. In blue Hermes > DDA. In red DDA > Hermes.
ggplot() + geom_density(data = mergedInt[mergedInt$diff > 0,], aes(x=diff), color = "blue") +
  geom_density(data = mergedInt[mergedInt$diff < 0,], aes(x=-diff), color = "red") + scale_x_log10()

#Fold change distribution. FC = Hermes / DDA
ggplot(mergedInt[mergedInt$FC < 10,]) + geom_density(aes(x=FC)) + scale_x_continuous(breaks=seq(0,10,0.5)) + geom_vline(aes(xintercept=1), color = "red")
```

## Spectral similarity comparison between DDA and Hermes overlapping scans

```{r}
#We select the scan with the highest TIC for each IL entry
Hermesbestscan <- lapply(Hermesoverlap, function(x){
  if(length(x) == 0){return()}
  x[[2]][x[[2]]$rt == x[[1]][which.max(x[[1]]$totIonCurrent), "retentionTime"], ]
})

DDAbestscan <- lapply(DDAoverlap, function(x){
  if(length(x) == 0){return()}
  x[[2]][x[[2]]$rt == x[[1]][which.max(x[[1]]$totIonCurrent), "retentionTime"], ]
})

#Calculate cosine similarities
cossim <- lapply(which(notZero), function(i){
  her <- Hermesbestscan[[i]][,1:2]
  names(her)[2] <- "rtiv"
  dda <- DDAbestscan[[i]][,1:2]
  names(dda)[2] <- "rtiv"
  MSMScosineSim(pattern = her, query = dda, minhits = 1)
}) %>% unlist()

hist(cossim, breaks = 50)
cos_dist <- sapply(seq(0,0.9,0.1), function(x){between(cossim, x, x+0.1) %>% which() %>% length()})
labels <- sapply(seq(0,0.9,0.1), function(x){paste(x, x+0.1, sep = "-")})
cos_df <- data.frame(cosines = cos_dist, labels = labels)
fig <- plot_ly(cos_df, labels = ~labels, values = ~cosines, type = 'pie')
fig <- fig %>% layout(title = 'Cosine similarity in overlapping entries between DDA and Hermes',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig
```
## Comparing identifications inside the IL
```{r}
myHermes@data@MS2Exp[[2]] <- myHermes@data@MS2Exp[[1]] #Copy IL to compare between DDA and Hermes more easily
myHermes@data@MS2Exp[[3]] <- myHermes@data@MS2Exp[[1]]

myHermes <- MS2Proc(myHermes, 2, Herfiles, useDB = T, mincos = 0.7,
                    referenceDB = "D:/MS2ID_B2R_20201113_083214.rds",
                    sstype = "1scan")

myHermes <- MS2Proc(myHermes, 3, DDAfiles, useDB = T, mincos = 0.7,
                    referenceDB = "D:/MS2ID_B2R_20201113_083214.rds",
                    sstype = "1scan")

saveRDS(myHermes, "D:/DDAHermes_Ecoli.rds")

ident_bool <- lapply(seq_len(nrow(myHermes@data@MS2Exp[[1]]@IL@IL)), function(i){
  paste(sapply(1:3, function(j){
    ifelse(any(myHermes@data@MS2Exp[[j]]@Ident$MS2Features$ILentry == i),1,0)
  }), collapse = "")
})
ident_bool <- as.data.frame(do.call(rbind, ident_bool))

table(ident_bool)

onlyHermes <- which(ident_bool$V1 %in% c("010", "110"))
onlyBestScan <- myHermes@data@MS2Exp[[2]]@Ident$MS2Features[myHermes@data@MS2Exp[[2]]@Ident$MS2Features$ILentry %in% onlyHermes,]
onlyBSident <- onlyBestScan[which(sapply(onlyBestScan$results, is.data.frame)),]
row.names(onlyBSident) <- 1:nrow(onlyBSident)

onlyss <-  myHermes@data@MS2Exp[[1]]@Ident$MS2Features[myHermes@data@MS2Exp[[1]]@Ident$MS2Features$ILentry %in% onlyHermes,]
onlySSident <- onlyss[which(sapply(onlyss$results, is.data.frame)),]

unique(c(onlySSident$ILentry, onlyBSident$ILentry)) %>% length()
```

## Matching the DDA scans outside the IL to RHermes SOIs

```{r}
matchInfo <- apply(DDAscans[,c(1,2)], 1, function(x){
  paste(sapply(c(1,2,4), function(SOI){
    ifelse(any(with(myHermes@data@SOI[[SOI]]@SoiList, x[1] > start & x[1] < end &
                    between(mass, x[2]-0.01, x[2]+0.01))), 1, 0)
  }), collapse = "")
})

matchInfo <- apply(DDAscans[,c(1,2)], 1, function(x){
  paste(sapply(c(1,2,4), function(SOI){
    browser()
    ifelse(any(with(myHermes@data@SOI[[SOI]]@SoiList, x[1] > start & x[1] < end &
                    between(mass, x[2]-0.01, x[2]+0.01))), 1, 0)
  }), collapse = "")
})

```



# Positive analysis - Plasma
```{r}

DDAfiles <- list.files("D:/ABrunner Plasma/DDA", pattern = "pos.*mzML", full.names = TRUE)

importMS2 <- function (filelist) {
    filesdata <- mapply(function(f, n) {
        hand <- mzR::openMSfile(f)
        pks <- mzR::peaks(hand)
        h <- mzR::header(hand)
        pks <- pks[which(h$msLevel == 2)]
        h <- h[which(h$msLevel == 2), ]
        h <- cbind(h, runnum = rep(n, times = nrow(h)))
        return(list(h, pks))
    }, filelist, seq_along(filelist))
    heads <- do.call(rbind, filesdata[seq(1, length(filesdata), 
        2)])
    peaks <- unlist(filesdata[seq(2, length(filesdata), 2)], 
        recursive = FALSE)
    return(list(heads, peaks))
}
DDA <- importMS2(DDAfiles)
```

```{r}
Herfiles <- list.files("D:/ABrunner Plasma/MS2Data/", pattern = "pos.*mzML", full.names = TRUE)[c(seq(5,14), seq(16, 25))]
Her <- importMS2(Herfiles)
```

```{r}
Herscans <- Her[[1]][,c("retentionTime", "precursorMZ")]
Herscans$class <- "Hermes"

DDAscans <- DDA[[1]][,c("retentionTime", "precursorMZ")]
DDAscans$class <- "DDA"

Jointscans <- rbind(Herscans, DDAscans)
ggplotly(ggplot(Jointscans[sample(1:nrow(Jointscans),size = 20000),]) + geom_point(aes(x=retentionTime, y = precursorMZ, color = class), alpha = 0.3, size = 0.2))

```

```{r message=FALSE, warning=FALSE}
myHermes <- readRDS("D:/ABrunner Plasma/MS1_pos_ident_plasma.rds")

myHermes@data@MS2Exp[[1]]@IL@ILParam@filtermz <- 0.2

DDAoverlap <- RHermes:::MSMSimporter(myHermes@data@MS2Exp[[1]]@IL, DDAfiles)
DDAoverlap_header <- do.call(rbind, lapply(DDAoverlap, function(x){if(length(x)!= 0){x[[1]]}}))
DDAoverlap_header_nscans <- do.call(rbind, sapply(DDAoverlap, function(x){if(length(x)!= 0){nrow(x[[1]])}})) %>% as.data.frame()
DDAoverlap_header_nscans$class <- "DDA"

Hermesoverlap <-RHermes:::MSMSimporter(myHermes@data@MS2Exp[[1]]@IL, Herfiles)
Hermesoverlap_header <- do.call(rbind, lapply(Hermesoverlap, function(x){if(length(x)!= 0){x[[1]]}}))
Hermesoverlap_header_nscans <- do.call(rbind, sapply(Hermesoverlap, function(x){if(length(x)!= 0){nrow(x[[1]])}})) %>% as.data.frame()
Hermesoverlap_header_nscans$class <- "Hermes"


olap_summary <- data.frame(counts = c(nrow(DDAoverlap_header),nrow(DDAscans) - nrow(DDAoverlap_header)), 
                                       class = c("Within Hermes IL", "Outside Hermes IL"))
fig <- plot_ly(olap_summary, labels = ~class, values = ~counts, type = 'pie')
fig <- fig %>% layout(title = 'DDA scan location respect to Hermes',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig

mergeNscans <- rbind(DDAoverlap_header_nscans, Hermesoverlap_header_nscans)
ggplot(mergeNscans) + geom_density(aes(x=V1, color = class, fill = class), alpha = 0.7) + xlab("Number of scans per IL entry") + scale_x_continuous(breaks=seq(0,75,5), limits = c(0,75))

numOver <- length(which(sapply(DDAoverlap, function(x){length(x)!= 0})))
numTotal <- nrow(myHermes@data@MS2Exp[[1]]@IL@IL)
print(paste("% of IL entries covered by at least 1 DDA scan", numOver/numTotal*100))
```
## Comparing maximum scan intensity (using TIC)
```{r}
DDAcurrent <- sapply(DDAoverlap, function(x){
  if(length(x) == 0){return(0)}
  max(x[[1]]$totIonCurrent)
})
Hermescurrent <- sapply(Hermesoverlap, function(x){
  if(length(x) == 0){return(0)}
  max(x[[1]]$totIonCurrent)
})

notZero <- Hermescurrent != 0 & DDAcurrent != 0
table(Hermescurrent[notZero] > DDAcurrent[notZero])

mergedInt <- data.frame(intH = Hermescurrent[notZero], intD = DDAcurrent[notZero])
mergedInt$diff <- mergedInt$intH-mergedInt$intD
mergedInt$FC <- mergedInt$intH/mergedInt$intD

#Hermes TICs vs DDA TICs
ggplot(mergedInt) + geom_point(aes(x=intH, y=intD)) + scale_x_log10() + scale_y_log10() + geom_abline(aes(slope = 1, intercept = 0), color = "red")

#TIC difference distribution. In blue Hermes > DDA. In red DDA > Hermes.
ggplot() + geom_density(data = mergedInt[mergedInt$diff > 0,], aes(x=diff), color = "blue") +
  geom_density(data = mergedInt[mergedInt$diff < 0,], aes(x=-diff), color = "red") + scale_x_log10()

#Fold change distribution. FC = Hermes / DDA
ggplot(mergedInt[mergedInt$FC < 10,]) + geom_density(aes(x=FC)) + scale_x_continuous(breaks=seq(0,10,0.5)) + geom_vline(aes(xintercept=1), color = "red")
```


# Positive analysis - Surface Water No spike
```{r}

DDAfiles <- list.files("D:/ABrunner/CD DDA/", pattern = "pos.*mzML", full.names = TRUE)[c(4,5,6)]

importMS2 <- function (filelist) {
    filesdata <- mapply(function(f, n) {
        hand <- mzR::openMSfile(f)
        pks <- mzR::peaks(hand)
        h <- mzR::header(hand)
        pks <- pks[which(h$msLevel == 2)]
        h <- h[which(h$msLevel == 2), ]
        h <- cbind(h, runnum = rep(n, times = nrow(h)))
        return(list(h, pks))
    }, filelist, seq_along(filelist))
    heads <- do.call(rbind, filesdata[seq(1, length(filesdata), 
        2)])
    peaks <- unlist(filesdata[seq(2, length(filesdata), 2)], 
        recursive = FALSE)
    return(list(heads, peaks))
}
DDA <- importMS2(DDAfiles)
```

```{r}
Herfiles <- list.files("D:/ABrunner/MSMSdata/", pattern = "pos.*mzML", full.names = TRUE)[seq(1,31)]
Her <- importMS2(Herfiles)
```

```{r}
Herscans <- Her[[1]][,c("retentionTime", "precursorMZ")]
Herscans$class <- "Hermes"

DDAscans <- DDA[[1]][,c("retentionTime", "precursorMZ")]
DDAscans$class <- "DDA"

Jointscans <- rbind(Herscans, DDAscans)
ggplotly(ggplot(Jointscans[sample(1:nrow(Jointscans), 20000), ]) + geom_point(aes(x=retentionTime, y = precursorMZ, color = class), alpha = 0.3, size = 0.2))

```

```{r message=FALSE, warning=FALSE}
myHermes <- readRDS("D:/ABrunner/MS1_pos_Ident_Water.rds")

myHermes@data@MS2Exp[[1]]@IL@ILParam@filtermz <- 0.5

DDAoverlap <- RHermes:::MSMSimporter(myHermes@data@MS2Exp[[1]]@IL, DDAfiles)
DDAoverlap_header <- do.call(rbind, lapply(DDAoverlap, function(x){if(length(x)!= 0){x[[1]]}}))
DDAoverlap_header_nscans <- do.call(rbind, sapply(DDAoverlap, function(x){if(length(x)!= 0){nrow(x[[1]])}})) %>% as.data.frame()
DDAoverlap_header_nscans$class <- "DDA"

Hermesoverlap <-RHermes:::MSMSimporter(myHermes@data@MS2Exp[[1]]@IL, Herfiles)
Hermesoverlap_header <- do.call(rbind, lapply(Hermesoverlap, function(x){if(length(x)!= 0){x[[1]]}}))
Hermesoverlap_header_nscans <- do.call(rbind, sapply(Hermesoverlap, function(x){if(length(x)!= 0){nrow(x[[1]])}})) %>% as.data.frame()
Hermesoverlap_header_nscans$class <- "Hermes"


olap_summary <- data.frame(counts = c(nrow(DDAoverlap_header),nrow(DDAscans) - nrow(DDAoverlap_header)), 
                                       class = c("Within Hermes IL", "Outside Hermes IL"))
fig <- plot_ly(olap_summary, labels = ~class, values = ~counts, type = 'pie')
fig <- fig %>% layout(title = 'DDA scan location respect to Hermes',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig

mergeNscans <- rbind(DDAoverlap_header_nscans, Hermesoverlap_header_nscans)
ggplot(mergeNscans) + geom_density(aes(x=V1, color = class, fill = class), alpha = 0.7) + xlab("Number of scans per IL entry") + scale_x_continuous(breaks=seq(0,75,5), limits = c(0,75))

numOver <- length(which(sapply(DDAoverlap, function(x){length(x)!= 0})))
numTotal <- nrow(myHermes@data@MS2Exp[[1]]@IL@IL)
print(paste("% of IL entries covered by at least 1 DDA scan", numOver/numTotal*100))
```

## Comparing maximum scan intensity (using TIC)
```{r}
DDAcurrent <- sapply(DDAoverlap, function(x){
  if(length(x) == 0){return(0)}
  max(x[[1]]$totIonCurrent)
})
Hermescurrent <- sapply(Hermesoverlap, function(x){
  if(length(x) == 0){return(0)}
  max(x[[1]]$totIonCurrent)
})

notZero <- Hermescurrent != 0 & DDAcurrent != 0
table(Hermescurrent[notZero] > DDAcurrent[notZero])

mergedInt <- data.frame(intH = Hermescurrent[notZero], intD = DDAcurrent[notZero])
mergedInt$diff <- mergedInt$intH-mergedInt$intD
mergedInt$FC <- mergedInt$intH/mergedInt$intD

#Hermes TICs vs DDA TICs
ggplot(mergedInt) + geom_point(aes(x=intH, y=intD)) + scale_x_log10() + scale_y_log10() + geom_abline(aes(slope = 1, intercept = 0), color = "red")

#TIC difference distribution. In blue Hermes > DDA. In red DDA > Hermes.
ggplot() + geom_density(data = mergedInt[mergedInt$diff > 0,], aes(x=diff), color = "blue") +
  geom_density(data = mergedInt[mergedInt$diff < 0,], aes(x=-diff), color = "red") + scale_x_log10()

#Fold change distribution. FC = Hermes / DDA
ggplot(mergedInt[mergedInt$FC < 10,]) + geom_density(aes(x=FC)) + scale_x_continuous(breaks=seq(0,10,0.5)) + geom_vline(aes(xintercept=1), color = "red")
```


# Positive analysis - Surface Water Spike
```{r}

DDAfiles <- list.files("D:/ABrunner/CD DDA/", pattern = "pos.*mzML", full.names = TRUE)[c(7,8,9)]

importMS2 <- function (filelist) {
    filesdata <- mapply(function(f, n) {
        hand <- mzR::openMSfile(f)
        pks <- mzR::peaks(hand)
        h <- mzR::header(hand)
        pks <- pks[which(h$msLevel == 2)]
        h <- h[which(h$msLevel == 2), ]
        h <- cbind(h, runnum = rep(n, times = nrow(h)))
        return(list(h, pks))
    }, filelist, seq_along(filelist))
    heads <- do.call(rbind, filesdata[seq(1, length(filesdata), 
        2)])
    peaks <- unlist(filesdata[seq(2, length(filesdata), 2)], 
        recursive = FALSE)
    return(list(heads, peaks))
}
DDA <- importMS2(DDAfiles)
```

```{r}
Herfiles <- list.files("D:/ABrunner/MSMSdata/", pattern = "pos.*mzML", full.names = TRUE)[seq(35,45)]
Her <- importMS2(Herfiles)
```

```{r}
Herscans <- Her[[1]][,c("retentionTime", "precursorMZ")]
Herscans$class <- "Hermes"

DDAscans <- DDA[[1]][,c("retentionTime", "precursorMZ")]
DDAscans$class <- "DDA"

Jointscans <- rbind(Herscans, DDAscans)
ggplotly(ggplot(Jointscans[sample(1:nrow(Jointscans), 20000), ]) + geom_point(aes(x=retentionTime, y = precursorMZ, color = class), alpha = 0.3, size = 0.2))

```

```{r message=FALSE, warning=FALSE}
myHermes@data@MS2Exp[[3]]@IL@ILParam@filtermz <- 0.5

DDAoverlap <- RHermes:::MSMSimporter(myHermes@data@MS2Exp[[5]]@IL, DDAfiles)
DDAoverlap_header <- do.call(rbind, lapply(DDAoverlap, function(x){if(length(x)!= 0){x[[1]]}}))
DDAoverlap_header_nscans <- do.call(rbind, sapply(DDAoverlap, function(x){if(length(x)!= 0){nrow(x[[1]])}})) %>% as.data.frame()
DDAoverlap_header_nscans$class <- "DDA"

Hermesoverlap <-RHermes:::MSMSimporter(myHermes@data@MS2Exp[[5]]@IL, Herfiles)
Hermesoverlap_header <- do.call(rbind, lapply(Hermesoverlap, function(x){if(length(x)!= 0){x[[1]]}}))
Hermesoverlap_header_nscans <- do.call(rbind, sapply(Hermesoverlap, function(x){if(length(x)!= 0){nrow(x[[1]])}})) %>% as.data.frame()
Hermesoverlap_header_nscans$class <- "Hermes"


olap_summary <- data.frame(counts = c(nrow(DDAoverlap_header),nrow(DDAscans) - nrow(DDAoverlap_header)), 
                                       class = c("Within Hermes IL", "Outside Hermes IL"))
fig <- plot_ly(olap_summary, labels = ~class, values = ~counts, type = 'pie')
fig <- fig %>% layout(title = 'DDA scan location respect to Hermes',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig

mergeNscans <- rbind(DDAoverlap_header_nscans, Hermesoverlap_header_nscans)
ggplot(mergeNscans) + geom_density(aes(x=V1, color = class, fill = class), alpha = 0.7) + xlab("Number of scans per IL entry") + scale_x_continuous(breaks=seq(0,75,5), limits = c(0,75))

numOver <- length(which(sapply(DDAoverlap, function(x){length(x)!= 0})))
numTotal <- nrow(myHermes@data@MS2Exp[[1]]@IL@IL)
print(paste("% of IL entries covered by at least 1 DDA scan", numOver/numTotal*100))
```

## Comparing maximum scan intensity (using TIC)
```{r}
DDAcurrent <- sapply(DDAoverlap, function(x){
  if(length(x) == 0){return(0)}
  max(x[[1]]$totIonCurrent)
})
Hermescurrent <- sapply(Hermesoverlap, function(x){
  if(length(x) == 0){return(0)}
  max(x[[1]]$totIonCurrent)
})

notZero <- Hermescurrent != 0 & DDAcurrent != 0
table(Hermescurrent[notZero] > DDAcurrent[notZero])

mergedInt <- data.frame(intH = Hermescurrent[notZero], intD = DDAcurrent[notZero])
mergedInt$diff <- mergedInt$intH-mergedInt$intD
mergedInt$FC <- mergedInt$intH/mergedInt$intD

#Hermes TICs vs DDA TICs
ggplot(mergedInt) + geom_point(aes(x=intH, y=intD)) + scale_x_log10() + scale_y_log10() + geom_abline(aes(slope = 1, intercept = 0), color = "red")

#TIC difference distribution. In blue Hermes > DDA. In red DDA > Hermes.
ggplot() + geom_density(data = mergedInt[mergedInt$diff > 0,], aes(x=diff), color = "blue") +
  geom_density(data = mergedInt[mergedInt$diff < 0,], aes(x=-diff), color = "red") + scale_x_log10()

#Fold change distribution. FC = Hermes / DDA
ggplot(mergedInt[mergedInt$FC < 10,]) + geom_density(aes(x=FC)) + scale_x_continuous(breaks=seq(0,10,0.5)) + geom_vline(aes(xintercept=1), color = "red")
```



# Session Info
```{r}
sessionInfo()
```

