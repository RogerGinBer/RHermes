---
title: "RHermes User Guide"
author: "Roger Gine Bertomeu"
date: "`r Sys.Date()`"
output:
    html_document:
      theme: flatly
      highlight: tango
      toc: true
      toc_float: true
vignette: |
  %\VignetteIndexEntry{RHermes_UserGuide}
  %\VignetteEngine{knitr::knitr}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE)
knitr::opts_chunk$set(collapse = TRUE)
```

RHermes is an untargeted metabolomics data processing package. Its objective
is to identify a customizable set (usually >10K) of metabolites in a biological
or environmental sample.

This document will guide you through the package functions and show you what a
typical RHermes workflow looks like.

## Installation
The recommended specs for RHermes are:

 - At least a 4 core processor
 - 16 GB of RAM or more
 - An internet connection to perform KEGG queries

You can install the released version of RHermes from 
[Bioconductor](https://bioconductor.org/) with:

```{r, eval = FALSE}
if(!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("RHermes")
```

Alternatively, you can download the development version from
[GitHub](https://github.com/) with:

```{r, eval = FALSE}
if(!requireNamespace("devtools", quietly = TRUE))
    install.packages("devtools")
devtools::install_github("RogerGinBer/RHermes")
```

## MS1 workflow
### Setting up the RHermesExp object
All the information generated by RHermes is stored in a single 
RHermesExp object.
To generate it, use the S4 constructor:
```{r, message=FALSE}
library(RHermes)
myHermes <- RHermesExp()
```
This object will be the input of most of the package functions, which return an
updated version of the object.

After creating the object, set your MS1 experimental parameters. To do so, use
the function setExpParam(), which accepts either a custom ExpParam object or a
template name:
```{r}
myHermes <- setExpParam(myHermes, params = ExpParam(ppm = 4, res = 120000,
                                                    ion = "+"))
myHermes <- setExpParam(myHermes, template = "orbi-pos")
```
The following template names are available: "orbi-pos", "orbi-neg", 
"qtof-pos" and "qtof-neg". Check ?ExpParam to see all customizable fields.
All non-specified ExpParam fields are left as defaults.

After setting up the ExpParam, decide which set of formulas and adducts to
detect in our data with setDB(): 
```{r}
myHermes <- setDB(myHermes, db = "hmdb") #Loads a small HMDB subset
```
A general set of adducts will be automatically set according to the experimental
parameters. You can choose multicharged and multimer adducts by using the
*adcharge* and *admult* parameters in setDB().

In general, the less combinations, the faster the running time will be.
It is also advisable to remove unlikely adducts from the adduct list 
(such as those coming from unused solvents, eg. M+ACN+H).
To do so, you can check which adducts are in use with adlist(),
add new adduct profiles with addAd()
and remove adducts with remAd():

```{r}
#We will add the "M+2H" adduct
myHermes <- addAd(myHermes, name = "M+2H", deltam = 2*1.00727600, ch = 2,
                    mult = 1, toadd = "H2")

#For instance, remove adducts of unused solvents
myHermes <- remAd(myHermes, c("M+DMSO+H", "M+IsoProp+H"))

```
```{r eval=FALSE}
adlist(myHermes)
```
```{r echo=FALSE}
knitr::kable(adlist(myHermes))
```

<a name="cluster"></a>

Another parameter you would want to set up (especially if you're dealing with
many formulas and adducts - say >10K formulas) is your RHermesExp parallel
backend. By default, when initializing the object, your OS and RAM are checked 
and the most efficient BiocParallel backend is chosen (SnowParam for Windows 
users and MulticoreParam for Linux / MacOS users). The number of workers is
automatically estimated according to your RAM.

If you want to check what parallel settings you are using, just use Cluster()
```{r}
Cluster(myHermes)
```

In case you want to change your BiocParallel backend, pass the backend to 
setCluster(). This is particularly useful if you are dealing with short formula
lists and want to avoid parallel overhead times or if you want to reprocess
an old file (or a file processed in another computer) and the original backend
has already expired.
```{r}
#SerialParam as example, others are valid too
myHermes <- setCluster(myHermes, BiocParallel::SerialParam()) 
```


Wrapping up: here's what the object looks like up to this point:
```{r}
myHermes #Shows a summary of all set parameters and object info
```
As you can see above, the RHermesExp object keeps track of all processing steps
it's  gone through, as well as some other troubleshooting info like the OS and 
the RHermes version it was originally generated with.

### Processing the MS1 files into PL
The main interface to process files is the function processMS1(), which accepts
an RHermesExp object and a list of paths to the MS1 files to process. All the
files must share the used experimental parameters (meaning data acquired in
different polarities or in different instruments can't be processed at the
same time).

For this guide, we will use a small test mzML provided with the package:
```{r}
myHermes <- processMS1(myHermes,
                        system.file("ExtData/MS1TestData.mzML",
                                    package = "RHermes"))
```
Once done, you can check some stats about the files you've just processed:
```{r}
#You could do either of these, but PL it's more direct if you just want to check
#one file:
# myHermes
PL(myHermes, 1)
```

### SOI detection
Before diving into the process itself, we should talk first about the detection
parameters; There are two ways to generate them:

- Specify an already-made template with getSOIpar()

- Create your own custom set of parameters with the constructor SOIParam()

It works either way, but I'd advise to just use getSOIpar() because it's easier
and the templates have already been tested. There are six templates available,
which only differ by the number and width of the applied bins: *simple*,
*double*, *triple*, *simple-x*, *double-x*, and *triple-x*. -x meaning extended
bins (15s) as opposed to the default 5s bins. It's useful to use -x if you are
using a regular HPLC setup to avoid SOI splitting and to improve running time. 
On a UPLC setup, you can skip the -x.

So when should one use SOIParam directly? Well, it's convenient if you
want to change the bin sizes used for the scan density calculation and also if
you want to be stricter about the minimum required density or the minimum 
data point intensity (!).

Once you have your SOI parameters, pass them to findSOI and specify which files
you want to use:
```{r}
s <- getSOIpar("double")
myHermes <- findSOI(myHermes, s, 1)
```

And what about blank subtraction? It's actually really simple: just add an extra
blank argument to findSOI(). You can also generate as many SOIs as you want in
just one function call by passing a vector of sample IDs and blank-to-be-used
IDs (keep in mind that "No blank substraction" must be represented as 0).

Since our test dataset doesn't include blank data (it's just one file),
this next chunk will not be actually executed, but you get the gist of it:
```{r eval=FALSE}
#Generate a SOI list of file 2 without blank subtraction and another one
#using file 1 as blank
myHermes <- findSOI(myHermes, s, c(2,2), c(0,1))
```

### SOI filtering/clean-up

Now that you generated a SOI list, you can now filter it to remove low
intensity SOIs, bad isotopic fidelity SOIs and likely in-source fragments (ISF).

For intensity and isotopic fidelity filtering we use filterSOI():
```{r}
myHermes <- filterSOI(myHermes, id = 1, minint = 20000, isofidelity = TRUE)
```



### Generating an Inclusion List

## MS2 workflow

## Plotting

## Using the RHermes Shiny app
To start the app, simply type:
```{r, eval=FALSE}
RHermesGUI()
```
And the app should start in your default browser.


## Troubleshooting
Here we will review some common errors that may happen during processing:

- serialize(data, node$con) : error writing to connection

    - This error usually happens when the BiocParallel backend isn't valid
    anymore. (For instance, you are in a new R session, or using a RHermesExp
    object generated in another PC). Refer [here](#cluster)

## Session Info

```{r}
sessionInfo()
```

